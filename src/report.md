## Part 1. Инструмент ipcalc<br>
1. Сети и маски<br>
    * Устанавливаем **ipcalc** командой `sudo apt install ipcalc`<br>

    1) Адрес сети **192.167.38.54/13** `ipcalc 192.167.38.54/13`<br>
    ![Адрес сети](screen/1.png)*Адрес сети*<br><br>
    2) Перевод маски **255.255.255.0** в префиксную и двоичную запись `ipcalc 255.255.255.0`<br>
    ![Префиксная и двоичная запись](screen/2.png)*Префиксная и двоичная запись*<br><br>
    * **/15** в обычную и двоичную `ipcalc /15`<br>
    ![Обычная и двоичная запись](screen/3.png)*Обычная и двоичная запись*<br><br>
    * **11111111.11111111.11111111.11110000** перевел в десятичный вид и выполнил в обычную и префиксную `ipcalc 255.255.255.240`<br>
    ![Обычная и префиксная запись](screen/3.1.png)*Обычная и префиксная запись*<br><br>
    3) Минимальный и максимальный хост в сети **12.167.38.4** при масках:<br>
    * **/8** `ipcalc 12.167.38.4 /8`<br>
    ![HostMin & HostMax](screen/4.png)*HostMin & HostMax<br><br>
    * **11111111.11111111.00000000.00000000** `ipcalc 12.167.38.4 11111111.11111111.00000000.00000000`<br>
    ![HostMin & HostMax](screen/4.1.png)*HostMin & HostMax*<br><br>
    * **255.255.254.0** `ipcalc 12.167.38.4 255.255.254.0`<br>
    ![HostMin & HostMax](screen/5.png)*HostMin & HostMax<br><br>
    * **/4** `ipcalc 12.167.38.4 /4`<br>
    ![HostMin & HostMax](screen/6.png)*HostMin & HostMax<br><br>
    <br>
2. localhost<br>
    * По адресам **194.34.23.100** && **128.0.0.1** обратиться к приложению не получится, потому что у них нет петли.<br>
    * У **127.0.0.2** && **127.1.0.1** есть **loopback**, так что к ним обратиться можно.<br>
    ![127.0.0.2](screen/7.png)*127.0.0.2<br><br>
    ![127.1.0.1](screen/8.png)*127.1.0.1<br><br>
    <br>
3.  Диапазоны и сегменты сетей<br>
    1. <br>
    * **10.0.0.45** - Частный `ipcalc 10.0.0.45`<br>
    ![Private](screen/9.png)*Private*<br><br>
    * **134.43.0.2** - Публичный `ipcalc 134.43.0.2`<br>
    ![Public](screen/10.png)*Public*<br><br>
    * **192.168.4.2** - Частный `ipcalc 192.168.4.2`<br>
    ![Private](screen/11.png)*Private*<br><br>
    * **172.20.250.4** - Частный `ipcalc 172.20.250.4`<br>
    ![Private](screen/12.png)*Private*<br><br>
    * **172.0.2.1** - Публичный `ipcalc 172.0.2.1`<br>
    ![Public](screen/13.png)*Public*<br><br>
    * **192.172.0.1** - Публичный `ipcalc 192.172.0.1`<br>
    ![Public](screen/14.png)*Public*<br><br>
    * **172.68.0.2** - Публичный `ipcalc 172.68.0.2`<br>
    ![Public](screen/15.png)*Public*<br><br>
    * **172.16.255.255** - Частный `ipcalc 172.16.255.255`<br>
    ![Private](screen/16.png)*Private*<br><br>
    * **10.10.10.10** - Частный `ipcalc 10.10.10.10`<br>
    ![Private](screen/17.png)*Private*<br><br>
    * **192.169.168.1** - Публичный `ipcalc 192.169.168.1`<br>
    ![Public](screen/18.png)*Public*<br><br>

    2. <br>
        * **10.10.0.2** - да.<br>
        * **10.10.10.10** - да.<br>
        * **10.10.1.255** - да.<br>

## Part 2. Статическая маршрутизация между двумя машинами<br>
1. <br>
    * Поднимаем две виртуальные машины **ws1** && **ws2**<br>
* `ip a`<br>
    ![ip a](screen/19.png)*ip a*<br><br>
    * **ws1 && ws2** `sudo nano etc/netplan/00-installer-config.yaml`<br>
    ![ws1 && ws2](screen/20.png)*ws1 && ws2*<br><br>
    * Выполняем команды `sudo netplan apply` && `ip a`<br>
    * **ws1 && ws2**<br>
    ![ws1 && ws2](screen/21.png)*ws1 && ws2*<br><br>
    <br>

2. Добавление статического маршрута вручную<br>
    * Добавление статического маршрута от одной машины до другой и обратно при помощи команды `ip r add`<br>
    * **ws1** - `ip r add 172.24.116.8 dev enp0s8`<br>

    * **ws2** - `ip r add 192.168.100.10 dev enp0s8`<br>
    * Пропинговать соединение между машинами:<br>
    * **ws1**<br>
    ![ws1 && ws 2](screen/22.png)*ws1 && ws2*<br><br>
    * Добавление статического маршрута с сохранением<br>
    * `sudo nano /etc/netplan/00-installer-config.yaml`<br>
    ![ws1 && ws2](screen/23.png)*ws1 && ws 2*<br><br>
    * `sudo netplan apply`<br>
    * `sudo reboot`<br>
    <br>
    * Пропинговать соединение между машинами<br>
    * **ws1** - `ping 192.168.100.10`<br>
    * **ws2** - `ping 172.24.116.8`<br>
    ![ws1 && ws2](screen/24.png)*ws1 && ws2*<br><br>
    <br>
## Part 3. Утилита iperf3<br>
1. Перевести и записать в отчёт:<br>
    * 8 Mbps = 1 MS/s.<br>
    * 100 MB.s = 100000 Kbps.<br>
    * 1 Gbps = 1000 Mbps.<br>
    <br>
2. Утилита **iperf3**<br>
    * **ws1** - `iperf3 -s`<br>
    * **ws2** - `iperf3 -c 192.168.100.10 -p 5201`<br>
    ![ws1 && ws2](screen/25.png)*ws1 && ws2*<br><br>
    <br>
## Part 4. Сетевой экран<br>
1. Утилита **iptables**<br>
    * Устанавливаем **iptables** `sudo apt-get install iptables`<br>
    * на **ws1** применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)<br>
    * открыть на машинах доступ для порта **22** (ssh) и порта **80** (http)<br>
    * **запретить** echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)<br>
    * **разрешить** echo reply (машина должна "пинговаться")<br>
    * на **ws2** применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)<br>
    <br>
    * **разрешить** echo reply (машина должна "пинговаться")<br>
    * **запретить** echo reply (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)<br>
    * открыть на машинах доступ для порта **22** (ssh) и порта **80** (http)
    ![ws1 && ws2](screen/26.png)*ws1 && ws 2*<br><br>
    <br>
    * Запустить файлы на обеих машинах командами `sudo chmod +x /etc/firewall.sh` && `sudo sh /etc/firewall.sh`<br>
    ![ws1 && ws2](screen/27.png)*ws1 && ws2*<br><br>
    <br>
    * **ws1** - INPUT для пакетов на ping-reply DROP - не работает т.е. пакеты отправляет, но не принемает.<br>
    ![ws1](screen/28.png)*ws1*<br><br>
    * **ws2** - INPUT для пакетов на ping-reply ACCEPT - работает.<br>
    ![ws2](screen/29.png)*ws2*<br><br>
    <br>
2. Утилита **nmap**<br>
    * Устанавливаем **nmap** `sudo apt-get install nmap`<br>
    ![ws1](screen/30.png)*ws1*<br><br>
    <br>
## Part 5. Статическая маршрутизация сети<br>
1. Настройка адресов машин<br>
    * Настроить конфигурации машин в `etc/netplan/00-installer-config.yaml`<br>
    ![ws11 && ws21 && ws22 && r1 && r2](screen/31.png)*ws11 && ws21 && ws22 && r1 && r2*<br><br>
    <br>
    * Перезапустить сервис сети. Если ошибок нет, то командой `ip -4 a` проверить, что адрес машины задан верно.<br>
    ![ws11 && ws21](screen/32.png)*ws11 && ws21*<br><br>
    ![ws22 && r1 & r2](screen/33.png)*ws22 && r1 && r2*<br><br>
    <br>
    * Также пропинговать **ws22** && **ws21**. Аналогично пропинговать **r1** && **ws11**.
    ![ws22 && ws21](screen/34.png)*ws22 && ws21*<br><br>
    ![ws11 && r1](screen/35.png)*ws11 && r1*<br><br>
    <br>

2. Включение переадресации IP-адресов<br>
    * Для включения переадресации IP, выполните команду на роутерах: `sudo sysctl -w net.ipv4.ip_forward=1`<br>
    ![r1 && r2](screen/36.png)*r1 && r2*<br><br>
    * Откройте файл `/etc/sysctl.conf` и добавьте в него следующую строку: `net.ipv4.ip_forward = 1`<br>
    ![r1 && r2](screen/37.png)*r1 && r2*<br><br>
    <br>
3. Установка маршрута по-умолчанию<br>
    * Настроить маршрут по-умолчанию (шлюз) для рабочих станций. Для этого добавить **gateway4** [ip роутера] в файле конфигураций<br>
    ![ws11 && ws21 && ws22 && r1 && r2](screen/38.png)*ws11 && ws21 && ws22 && r1 && r2*<br><br>
    <br>
    * Вызвать `ip r` и показать, что добавился маршрут в таблицу маршрутизации<br>
    ![ws11 && ws21 && ws22 && r1 && r2](screen/39.png)*ws11 && ws21 && ws22 && r1 && r2*<br><br>
    <br>
    * Пропинговать с **ws11** роутер **r2** и показать на **r2**, что пинг доходит. Для этого использовать команду: `tcpdump -tn -i eth1`<br>
    ![ws11 && r2](screen/40.png)*ws11 && r2*<br><br>
    <br>
4. Добавление статических маршрутов<br>
    * Добавить в роутеры **r1** && **r2** статические маршруты в файле конфигураций.<br>
    ![r1 && r2](screen/41.png)*r1 && r2*<br><br>
    * Вызвать `ip r` и показать таблицы с маршрутами на обоих роутерах.<br>
    ![r1 && r2](screen/42.png)*r1 && r2*<br><br>
    * Запустить команды на **ws11**: `ip r list 10.10.0.0/18` <br>
    ![ws11](screen/42.1.png)
    `ip r list 0.0.0.0/0`
    ![ws11](screen/42.2.png)*ws11*<br><br>
    * В отчете выбран путь отличный от **10.10.0.0** - этот адрес указывает на все адреса.<br>
    <br>
5. Построение списка маршрутизаторов<br>
    * Запустить на **r1** команду дампа: `tcpdump -tnv -i enp0s8`<br>
    ![r1](screen/43.png)*r1*<br><br>
    * При помощи утилиты `traceroute` построить список маршрутизаторов на пути от **ws11** до **ws21** `traceroute 10.20.0.10`<br>
    ![ws11](screen/44.png)*ws11*<br><br>
    * Путь строится от узла к узлу до того момента, пока не будет достигнута конечная точка. Каждый пакет проходит на своем пути определенное количество узлов, пока не достигнет своей цели. На каждом узле добавляется счетчик, который отслеживает количество пройденых узлов.<br>
    <br>
6. Использование протокола **ICMP** при маршрутизации<br>
    * Запустить на **r1** перехват сетевого трафика, проходящего через **enp0s8** с помощью команды: 
    * Пропинговать с **ws11** несуществующий **IP** (например, **10.30.0.111**) с помощью команды: `ping -c 1 10.30.0.111`<br>
    ![ws11](screen/45.png)*ws11*<br><br>
    <br>
## Part 6. Динамическая настройка IP с помощью DHCP<br>
1. Для **r2** настроить в файле `/etc/dhcp/dhcpd.conf` конфигурацию службы **DHCP**:<br>
    * указать адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети.<br>
    ![r2](screen/47.png)*r2*<br><br>
    <br>
2.  * в файле `/etc/resolv.conf` прописать `nameserver 8.8.8.8.`<br>
    ![r2](screen/48.png)*r2*<br><br>
    * Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`<br>
    ![r2](screen/49.png)*r2*<br><br>
    * Машину **ws21** перезагрузить при помощи `sudo reboot` и через `ip a` показать, что она получила адрес.<br>
    ![ws21](screen/50.png)*ws21*<br><br>
    * Также пропинговать **ws22** && **ws21**.<br>
    ![ws22](screen/51.png)*ws22 && ws21*<br><br>
    * Указать MAC адрес у **ws11**, для этого в `etc/netplan/00-installer-config.yaml` надо добавить строки: **macaddress: 10:10:10:10:10:BA**, **dhcp4: true**<br>
    ![ws11](screen/52.png)*ws11*<br><br>
    * Для **r1** настроить аналогично **r2**, но сделать выдачу адресов с жесткой привязкой к **MAC-адресу (ws11)**. Провести аналогичные тесты.<br>
    ![r1](screen/53.png)*r1*<br><br> 
    * Перезагрузить службу **DHCP** командой `systemctl restart isc-dhcp-server`<br>
    ![r1](screen/54.png)*r1*<br><br>
    * Машину **ws11** перезагрузить при помощи `sudo reboot` и через `ip a` показать, что она получила адрес.<br>
    ![ws11](screen/55.png)*ws11*<br><br>
    <br>
3. Запросить с ws21 обновление ip адреса<br>
    * В отчёте поместить скрины ip до и после обновления.<br>
    ![ws21](screen/55.1.png)*ws21*<br><br>
    ![ws21](screen/56.png)*ws21*<br><br>
    * В отчёте описать, какими опциями DHCP сервера пользовались в данном пункте.<br>
    * **dhclient -r** && **dhclient -v**<br>

## Part 7. NAT<br>
1. В файле `/etc/apache2/ports.conf` на **ws22** && **r1** изменить строку **Listen 80** на **Listen 0.0.0.0:80**, то есть сделать сервер **Apache2** общедоступным<br>
    ![ws22 && r1](screen/57.png)*ws22 && r1*<br><br>
    * Запустить веб-сервер **Apache** командой `service apache2 start` на **ws22** && **r1**<br>
    * Добавить в фаервол, созданный по аналогии с фаерволом из **Части 4**, на **r2** следующие правила:<br>
    1) Удаление правил в таблице **filter** - `iptables -F`<br>
    2) Удаление правил в таблице **NAT** - `iptables -F -t nat`<br>
    3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`<br>
    ![r2](screen/58.png)*r2*<br><br>
    * Запускать файл также, как в **Части 4.**<br>
    * Проверить соединение между **ws22** && **r1** командой `ping`<br>
    * При запуске файла с этими правилами, **ws22 не должна** "пинговаться" с **r1**<br>
    ![ws22](screen/59.png)*ws22*<br><br>
    * Добавить в файл ещё одно правило:<br>
    4) Разрешить маршрутизацию всех пакетов протокола **ICMP**<br>
    ![r1](screen/60.png)*r1*<br><br>
    * Проверить соединение между **ws22** && **r1** командой `ping`<br>
    * При запуске файла с этими правилами, **ws22 должна** "пинговаться" с **r1**<br>
    ![r2](screen/61.png)*r2*<br><br>
    * Добавить в файл ещё два правила:<br>
    5) Включить **SNAT**, а именно маскирование всех локальных **ip** из локальной сети, находящейся за **r2** (по обозначениям из **Части 5** - **сеть 10.20.0.0**)<br>
    6) Включить **DNAT** на **8080 порт** машины **r2** и добавить к веб-серверу **Apache**, запущенному на **ws22**, доступ извне сети<br>
    ![r2](screen/62.png)
    ![r2](screen/63.png)*r2*<br><br>
    * Запускать файл также, как в **Части 4**<br>
    * Проверить соединение по TCP для SNAT, для этого с ws22 подключиться к серверу Apache на r1 командой: `telnet`
    ![ws22](screen/64.png)*ws22*<br><br>
    * Проверить соединение по **TCP** для **DNAT**, для этого с **r1** подключиться к серверу **Apache** на **ws22** командой `telnet` (обращаться по адресу **r2** и порту **8080**)<br>
    ![r1](screen/65.png)*r1*<br><br>

## Part 8. Дополнительно. Знакомство с SSH Tunnels<br>
1. Запустить веб-сервер Apache на ws22 только на localhost (то есть не изменять файл /etc/apache2/ports.conf или, если был изменен ранее, вернуть строку Listen 80)<br>
![ws22](screen/66.png)*ws22*<br><br>
    * Раскомментировал `port 22` && `AllowTcpForwarding` в `/etc/ssh/sshd_config`
    ![ws22](screen/67.png)
    ![ws22](screen/68.png)*ws22*<br><br>
    * Воспользоваться Local TCP forwarding с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21<br>
    ![ws22](screen/69.png)*ws22*<br><br>
    * Воспользоваться Remote TCP forwarding c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11<br>
    ![ws22](screen/70.png)*ws22*<br><br>
    * Для проверки, сработало ли подключение в обоих предыдущих пунктах, перейдите во второй терминал (например, клавишами Alt + F2) и выполните команду: `telnet 127.0.0.1 [локальный порт]`<br>
    ![ws11](screen/72.png)*ws11*<br><br>
    ![ws21](screen/71.png)*ws21*<br><br>
    ![ws21](screen/73.png)*ws22*<br><br>